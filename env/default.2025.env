## set SYSTEMNAME if not yet set
if [ -z "${SYSTEMNAME}" ]; then
   if [ $(command -v sinfo) ]; then
      export SYSTEMNAME=$(scontrol show config | grep ClusterName | awk -F= '{ print $2 }' | cut -c 2-)
   else
      export SYSTEMNAME=$(hostname -s | sed 's/[0-9]*$//')
   fi
fi

MACHINE=$(hostname)
known_machine="true"
if [[ $MACHINE == *jupiter* ]]; then
  ENV_FILE=jsc.2025.gnu.openmpi
  DEFAULT_COMPILER="gnu"
elif [[ $MACHINE == *"jureca"* || $MACHINE == *"juwels"* || $MACHINE == *"jusuf"* ]]; then
  ENV_FILE=jsc.2025.intel.psmpi
  DEFAULT_COMPILER="intel"
elif [[ $MACHINE == *marvin* ]]; then
  # TODO: Verify this
  SYSTEMNAME=marvin
  ENV_FILE=ubuntu.gnu.openmpi
  DEFAULT_COMPILER="gnu"
elif [[ $MACHINE == *UBUNTU* ]]; then
  ENV_FILE=ubuntu.gnu.openmpi
  DEFAULT_COMPILER="gnu"
else
  echo "ERROR: Unknown default environment for machine '$(hostname)'"
  known_machine="false"
fi

if [[ ${known_machine} != "false" ]]; then
  TSMP2_ROOT=$(git rev-parse --show-toplevel)
  echo "Sourcing default environment file "${ENV_FILE}" for ${SYSTEMNAME^^} ... "
  if [[ "$1" == "--parflowgpu" ]]; then
    source ${TSMP2_ROOT}/env/${ENV_FILE} --parflowgpu
  else
    source ${TSMP2_ROOT}/env/${ENV_FILE}
  fi
fi
